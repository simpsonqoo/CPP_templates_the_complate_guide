---
tags: template c++
---

# 11.1 可呼叫物件(Callable Object)
在實作上常常需要傳入可以"被呼叫"的個體，例如使用thread進行排成、定義容器內部如何排序的物件(函式)，通常都可用f(...)來呼叫。

而若是呼叫這些物件的同時也需要傳入其argument，通常都會照順序呼叫並傳入，這種行為稱為callback

而使用這些物件，可以使用callback行為，也可以單純使用f(...)來呼叫。

e.g.
```cpp
void foo(int a, int b);

std::thread(foo, 1, 2);    // callback，1放入a，2放入b
foo(1, 2);                 // f(...)形式
```

而可以使用上述行為的共有下列幾種語法
- 函式指標(如上例之foo)
- 重載operator()的class(也包括lambda expression)
- 帶有轉換函式，能回傳函式指標或函式reference的class

以上三種稱為function object type，而以此建立的物件稱為function object

而callable又是C++再延伸的概念，除了function object外，也可以是指向member的指標，只要能像是函式一樣被呼叫的都稱為callable object。

而由於callable object能有各種形式，template可以為我們做到能接受各種形式的callable object的功能

# 11.1.1 支援函式物件
這裡實作STL內std::for_each函式，為了避免和STL衝突，取名為foreach

e.g.
```cpp
// foreach.hpp
template <typename Iter, typename Callable>
void foreach(Iter current, Iter end, Callable op)
{
    while (current != end)
    {
        op (*current);
        ++current;
    }
}

// foreach.cpp
void func(int i)
{
    std::cout << "call func\t" << i << std::endl;
}

class FuncObj
{
  public:
    void operator() (int i) const
    {
        std::cout << "call FuncObj::op()\t" << i << std::endl;
    }
};

int main()
{
    std::vector<int> vec{1, 2, 3};
    foreach(vec.begin(), vec.end(), func);
    foreach(vec.begin(), vec.end(), &func);
    foreach(vec.begin(), vec.end(), FuncObj());
    foreach(vec.begin(), vec.end(), [](int i){std::cout << "lambda expression\t" << i << std::endl;});
}
```

```cpp
class MyClass
{
  public:
    void foo(std::string const& str, int i) const
    {
        std::cout << i << '\t' << str << std::endl;
    }
};

template <typename Iter, typename Callable, typename... Args>
void foreach(Iter current, Iter end, Callable op, Args const&... args)
{
    while (current != end)
    {
        std::invoke(op, args..., *current);
        ++current;
    }
}

int main()
{
    std::vector<int> a{1, 2, 3};

    MyClass c;
    std::string str("hello");
    foreach(a.begin(), a.end(), &MyClass::foo, c, str);

    foreach(a.begin(), a.end(), [](std::string str, int n){std::cout << n << '\t' << str << std::endl;}, "hi");
}```